import{C as x}from"./chartManager-DTtrTfBc.js";class w{constructor(e){this.token=e}static parseUrl(e){try{const t=new URL(e),s=t.pathname.split("/")[2],o=t.searchParams.get("node-id");if(!o)throw new Error("node-id não encontrado na URL");const a=o.replace("-",":");return{fileKey:s,nodeId:a}}catch(t){return console.error("Erro ao analisar URL do Figma:",t),null}}async fetchFrame(e,t){try{const n=await fetch(`https://api.figma.com/v1/files/${e}/nodes?ids=${t}`,{headers:{"X-Figma-Token":this.token}});if(!n.ok)throw new Error(`Erro da API do Figma: ${n.status} ${n.statusText}`);const o=(await n.json()).nodes[t];if(!o||!o.document)throw new Error("Frame não encontrado");return o.document}catch(n){throw console.error("Erro ao buscar frame do Figma:",n),n}}async validateToken(){try{return(await fetch("https://api.figma.com/v1/me",{headers:{"X-Figma-Token":this.token}})).ok}catch(e){return console.error("Erro ao validar token:",e),!1}}}const h=class h{static savePattern(e){const n=this.getPatterns().filter(s=>s.frameId!==e.frameId);n.push(e),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n))}static getPatterns(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):[]}catch(e){return console.error("Erro ao recuperar padrões:",e),[]}}static getPatternByFrameId(e){return this.getPatterns().find(n=>n.frameId===e)||null}static addFeedbackToPattern(e,t){const n=this.getPatterns(),s=n.findIndex(o=>o.frameId===e);if(s!==-1){n[s].feedback||(n[s].feedback=[]),n[s].feedback.push(t);const o=this.generateRulesFromFeedback(t);o.length>0&&(this.saveAnalysisRules(o),n[s].analysisRules||(n[s].analysisRules=[]),n[s].analysisRules.push(...o)),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n)),this.autoSaveFeedbackToFile(e,t)}}static autoSaveFeedbackToFile(e,t){const n={timestamp:new Date().toISOString(),frameId:e,feedback:t,userAgent:navigator.userAgent,sessionId:this.getOrCreateSessionId()},s=`figma-feedback-${e}-${Date.now()}.json`,o=JSON.stringify(n,null,2);this.downloadFile(o,s,"application/json"),console.log("📤 Feedback salvo automaticamente:",s)}static getOrCreateSessionId(){const e="figma-analysis-session-id";let t=localStorage.getItem(e);return t||(t=`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem(e,t)),t}static generateRulesFromFeedback(e){const t=[],n=`rule_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;switch(e.type){case"missed_component":e.componentName&&(t.push({id:n,type:"include",condition:{nodeName:e.componentName},action:{classify:e.expectedClassification||"disconnected"},confidence:.8,source:"user_feedback",createdAt:Date.now()}),e.componentName.includes("Rectangle")&&t.push({id:`${n}_pattern`,type:"include",condition:{namePattern:"Rectangle.*"},action:{classify:e.expectedClassification||"disconnected"},confidence:.6,source:"user_feedback",createdAt:Date.now()}));break;case"wrong_classification":e.componentName&&t.push({id:n,type:"classify",condition:{nodeName:e.componentName},action:{classify:e.expectedClassification||"disconnected"},confidence:.9,source:"user_feedback",createdAt:Date.now()});break;case"should_ignore":e.componentName&&t.push({id:n,type:"exclude",condition:{nodeName:e.componentName},action:{ignore:!0},confidence:.9,source:"user_feedback",createdAt:Date.now()});break}return t}static saveAnalysisRules(e){const s=[...this.getAnalysisRules(),...e].filter((o,a,i)=>a===i.findIndex(r=>r.id===o.id));localStorage.setItem(this.RULES_KEY,JSON.stringify(s))}static getAnalysisRules(){try{const e=localStorage.getItem(this.RULES_KEY);return e?JSON.parse(e):[]}catch(e){return console.error("Erro ao recuperar regras:",e),[]}}static applyRulesToComponent(e,t){const n=this.getAnalysisRules(),s=[];let o=!1,a,i=!1;const r=n.sort((c,l)=>l.confidence-c.confidence);for(const c of r){let l=!1;if(c.condition.nodeName&&c.condition.nodeName===e?l=!0:c.condition.namePattern?new RegExp(c.condition.namePattern).test(e)&&(l=!0):c.condition.nodeType&&c.condition.nodeType===t&&(l=!0),l){if(s.push(c),c.action.ignore){i=!0;break}c.action.classify&&(a=c.action.classify),c.type==="include"&&(o=!0)}}return{shouldInclude:o,classification:a,shouldIgnore:i,appliedRules:s}}static initializeKnownPatterns(){if(this.getPatterns().length>0)return;const t=[{frameId:"8287:54836",frameUrl:"https://www.figma.com/design/Ibss9YekrWOz9EbjaNBcB5/Gera%C3%A7%C3%A3o-e-leitura-do-CNAB?node-id=8287-54836",timestamp:Date.now(),components:{connected:1,disconnected:0}},{frameId:"8287:53586",frameUrl:"https://www.figma.com/design/Ibss9YekrWOz9EbjaNBcB5/Gera%C3%A7%C3%A3o-e-leitura-do-CNAB?node-id=8287-53586",timestamp:Date.now(),components:{connected:0,disconnected:1}},{frameId:"8287:54843",frameUrl:"https://www.figma.com/design/Ibss9YekrWOz9EbjaNBcB5/Gera%C3%A7%C3%A3o-e-leitura-do-CNAB?node-id=8287-54843",timestamp:Date.now(),components:{connected:1,disconnected:1}}];localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t))}static saveToken(e){localStorage.setItem(this.TOKEN_KEY,e)}static getToken(){return localStorage.getItem(this.TOKEN_KEY)}static clearToken(){localStorage.removeItem(this.TOKEN_KEY)}static exportToCsv(e,t){const n=["Nome do Componente","Tipo","Conectado ao DS","Prioridade","Node ID"],s=e.map(a=>[a.name,a.type,a.isConnectedToDS?"Sim":"Não",a.priority,a.nodeId]);return[n.join(","),...s.map(a=>a.join(","))].join(`
`)}static downloadCsv(e,t){const n=new Blob([e],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");if(s.download!==void 0){const o=URL.createObjectURL(n);s.setAttribute("href",o),s.setAttribute("download",t),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s)}}static downloadFile(e,t,n){const s=new Blob([e],{type:`${n};charset=utf-8;`}),o=document.createElement("a");if(o.download!==void 0){const a=URL.createObjectURL(s);o.setAttribute("href",a),o.setAttribute("download",t),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o)}}static exportAllLearningData(){const e=this.getPatterns(),t=this.getAnalysisRules(),n=this.getLearningStats(),s={exportInfo:{timestamp:new Date().toISOString(),version:"1.0.0",sessionId:this.getOrCreateSessionId(),userAgent:navigator.userAgent},statistics:n,patterns:e,rules:t},o=`figma-learning-data-export-${Date.now()}.json`,a=JSON.stringify(s,null,2);this.downloadFile(a,o,"application/json"),console.log("📦 Dados de aprendizado exportados:",o)}static clearAllData(){localStorage.removeItem(this.STORAGE_KEY),localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.RULES_KEY)}static getLearningStats(){const e=this.getPatterns(),t=this.getAnalysisRules(),n=e.reduce((o,a)=>{var i;return o+(((i=a.feedback)==null?void 0:i.length)||0)},0),s=t.reduce((o,a)=>(o[a.type]=(o[a.type]||0)+1,o),{});return{totalPatterns:e.length,totalFeedbacks:n,totalRules:t.length,rulesBreakdown:s}}};h.STORAGE_KEY="figma-component-analysis-patterns",h.TOKEN_KEY="figma-token",h.RULES_KEY="figma-analysis-rules";let d=h;class v{static analyzeFrame(e,t){const n=[];this.extractComponents(e,n,0);const s=this.filterRelevantComponents(n),o=s.filter(i=>i.isConnectedToDS).length,a=s.filter(i=>!i.isConnectedToDS).length;return{components:s,summary:{connected:o,disconnected:a,total:o+a},frameInfo:{name:e.name,nodeId:e.id,url:t}}}static extractComponents(e,t,n){if(n===0&&e.children){e.children.forEach(o=>{this.extractComponents(o,t,n+1)});return}if(e.name.startsWith("_"))return;console.log(`🔍 Analisando node: "${e.name}" (${e.type}) - componentId: ${e.componentId||"null"} - depth: ${n}`);const s=d.applyRulesToComponent(e.name,e.type);if(s.shouldIgnore){console.log(`🚫 Ignorando componente "${e.name}" devido a regra aprendida`);return}if(e.type==="INSTANCE"){let o=!1;s.classification?o=s.classification==="connected":o=!!(e.componentId&&e.componentId.trim()!==""),console.log(`📍 INSTANCE "${e.name}": componentId="${e.componentId}" → ${o?"CONECTADO":"DESCONECTADO"}`),t.push({name:e.name,type:"INSTANCE",isConnectedToDS:o,priority:this.calculatePriority(e),nodeId:e.id,depth:n}),s.appliedRules.length>0&&console.log(`🎯 Aplicadas ${s.appliedRules.length} regras ao componente "${e.name}"`);return}if(e.type==="COMPONENT"){let o=!1;s.classification?o=s.classification==="connected":o=!1,console.log(`🧩 COMPONENT "${e.name}": → ${o?"CONECTADO":"DESCONECTADO"}`),t.push({name:e.name,type:"COMPONENT",isConnectedToDS:o,priority:this.calculatePriority(e),nodeId:e.id,depth:n}),s.appliedRules.length>0&&console.log(`🎯 Aplicadas ${s.appliedRules.length} regras ao componente "${e.name}"`);return}if(s.shouldInclude&&(e.type==="RECTANGLE"||e.type==="TEXT"||e.type==="ELLIPSE"||e.type==="VECTOR")){const o=s.classification||"disconnected";console.log(`✅ Incluído elemento "${e.name}" (${e.type}) devido a regra aprendida → ${o.toUpperCase()}`),t.push({name:e.name,type:"OTHER",isConnectedToDS:o==="connected",priority:this.calculatePriority(e),nodeId:e.id,depth:n})}else this.shouldIncludeAsDisconnectedComponent(e,n)&&(console.log(`🔶 Auto-detectado como componente desconectado: "${e.name}" (${e.type})`),t.push({name:e.name,type:"OTHER",isConnectedToDS:!1,priority:this.calculatePriority(e),nodeId:e.id,depth:n}));e.children&&e.children.forEach(o=>{o.type==="TEXT"&&e.type==="INSTANCE"||this.extractComponents(o,t,n+1)})}static filterRelevantComponents(e){return e.filter(t=>t.type==="INSTANCE"||t.type==="COMPONENT"?!0:t.type==="OTHER")}static shouldIncludeAsDisconnectedComponent(e,t){if(t>4||!["RECTANGLE","ELLIPSE","VECTOR","FRAME","GROUP"].includes(e.type))return!1;if(e.absoluteBoundingBox){const{width:i,height:r}=e.absoluteBoundingBox;if(i<20||r<20||i>500||r>500)return!1}const o=[/button/i,/btn/i,/card/i,/modal/i,/popup/i,/tooltip/i,/input/i,/field/i,/form/i,/checkbox/i,/radio/i,/icon/i,/avatar/i,/badge/i,/chip/i,/tag/i,/header/i,/footer/i,/sidebar/i,/menu/i,/nav/i,/component/i,/element/i,/widget/i,/rectangle \d+/i,/ellipse \d+/i,/vector \d+/i].some(i=>i.test(e.name)),a=!!(e.children&&e.children.length>0);return o||a&&t<=2}static calculatePriority(e){return e.type==="INSTANCE"?1:e.type==="COMPONENT"?2:3}static categorizeComponents(e){const t={connected:[],disconnected:[]};return e.forEach(n=>{n.isConnectedToDS?t.connected.push(n):t.disconnected.push(n)}),t}static getSuggestedMissedComponents(e){const t=[],n=(o,a)=>{a>0&&!o.name.startsWith("_")&&(o.type==="RECTANGLE"||o.type==="ELLIPSE"||o.type==="VECTOR")&&o.absoluteBoundingBox&&o.absoluteBoundingBox.width>10&&o.absoluteBoundingBox.height>10&&t.push({name:o.name,type:o.type,nodeId:o.id}),o.children&&o.type!=="INSTANCE"&&o.children.forEach(i=>n(i,a+1))};return n(e,0),t.filter((o,a,i)=>a===i.findIndex(r=>r.name===o.name)).slice(0,10)}}const f=class f{static isAuthenticated(){const e=this.getAuthData();return e?Date.now()>e.expiresAt?(this.logout(),!1):!0:!1}static login(e,t){const n=this.VALID_USERS[e];if(!n||n!==t)return!1;const s={email:e,loginTime:Date.now(),expiresAt:Date.now()+this.SESSION_DURATION};return localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s)),!0}static logout(){localStorage.removeItem(this.STORAGE_KEY)}static getAuthData(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):null}catch{return null}}static getCurrentUser(){const e=this.getAuthData();return(e==null?void 0:e.email)||null}static shouldRenewSession(){const e=this.getAuthData();if(!e)return!1;const t=e.expiresAt-Date.now(),n=60*60*1e3;return t<n}static renewSession(){const e=this.getAuthData();e&&(e.expiresAt=Date.now()+this.SESSION_DURATION,localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e)))}};f.STORAGE_KEY="figma-analyzer-auth",f.SESSION_DURATION=24*60*60*1e3,f.VALID_USERS={"design@qive.com":"design2024","ux@qive.com":"ux2024","admin@qive.com":"admin2024","rafael@qive.com":"dev2024"};let p=f;class S{constructor(){this.chartManager=null,this.currentAnalysisResult=null}setChartManager(e){this.chartManager=e}updateSummaryCards(e){const t=document.querySelectorAll(".summary-card");if(t.length>=3){const i=t[0].querySelector(".summary-value");i&&(i.textContent=e.summary.connected.toString());const r=t[1].querySelector(".summary-value");r&&(r.textContent=e.summary.disconnected.toString());const c=t[2].querySelector(".summary-value");c&&(c.textContent=e.summary.total.toString())}const n=document.getElementById("connected-count");n&&(n.textContent=e.summary.connected.toString());const s=document.getElementById("disconnected-count");s&&(s.textContent=e.summary.disconnected.toString());const o=document.getElementById("compliance-rate"),a=document.getElementById("compliance-status");if(o&&a){const i=e.summary.total>0?Math.round(e.summary.connected/e.summary.total*100):0;o.textContent=`${i}%`,i>=80?(a.textContent="Aprovado",a.className="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800"):(a.textContent="Revisar",a.className="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800"),a.classList.remove("hidden")}}updateComponentsTable(e){const t=document.getElementById("components-table-body");if(!t)return;const n=v.categorizeComponents(e.components);t.innerHTML="",n.connected.forEach(s=>{const o=this.createComponentRow(s,!0,e.frameInfo.url);t.appendChild(o)}),n.disconnected.forEach(s=>{const o=this.createComponentRow(s,!1,e.frameInfo.url);t.appendChild(o)}),this.setupToggleListeners()}createComponentRow(e,t,n){const s=document.createElement("tr");s.className="border-b border-gray-200 hover:bg-gray-50";const o=t?'<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Conectado</span>':'<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Desconectado</span>',i=`
      <label class="relative inline-flex items-center cursor-pointer justify-center">
        <input type="checkbox" id="${`toggle-${e.nodeId.replace(":","-")}`}" class="sr-only peer component-toggle" checked data-node-id="${e.nodeId}">
        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
      </label>
    `,r=this.createFigmaElementUrl(n,e.nodeId),c=r?`<a href="${r}" target="_blank" class="text-red-600 hover:text-red-800 underline font-mono text-sm" title="Abrir elemento no Figma">${e.nodeId} 🔗</a>`:`<span class="font-mono text-sm text-gray-500">${e.nodeId}</span>`;return s.innerHTML=`
      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
        ${e.name}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
        ${e.type}
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        ${o}
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        ${c}
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        ${i}
      </td>
    `,s}createFigmaElementUrl(e,t){try{const n=new URL(e),s=t.replace(":","-");return n.searchParams.set("node-id",s),n.toString()}catch(n){return console.error("Erro ao criar URL do elemento Figma:",n),null}}setupToggleListeners(){document.querySelectorAll(".component-toggle").forEach(t=>{t.addEventListener("change",()=>{this.recalculateStats()})})}recalculateStats(){const e=document.querySelectorAll(".component-toggle");let t=0,n=0;console.log(`🔄 Recalculando estatísticas... ${e.length} toggles encontrados`),e.forEach(s=>{if(!s.checked){console.log(`⏭️ Toggle desabilitado para nodeId: ${s.dataset.nodeId}`);return}const o=s.closest("tr");if(!o){console.log(`❌ Linha não encontrada para toggle: ${s.dataset.nodeId}`);return}const a=o.querySelectorAll("span");let i=!1;a.forEach(r=>{var c;(c=r.textContent)!=null&&c.includes("Conectado")&&(i=!0)}),i?(t++,console.log(`✅ Componente conectado contabilizado: ${s.dataset.nodeId}`)):(n++,console.log(`❌ Componente desconectado contabilizado: ${s.dataset.nodeId}`))}),console.log(`📊 Resultado final: ${t} conectados, ${n} desconectados`),this.updateSummaryCardsWithCustomValues(t,n),this.updateAnalysisSummary(t,n),this.chartManager&&this.chartManager.updatePieChartWithValues(t,n)}updateSummaryCardsWithCustomValues(e,t){const n=document.querySelectorAll(".summary-card .summary-value");n.length>=3&&(n[0].textContent=e.toString(),n[1].textContent=t.toString(),n[2].textContent=(e+t).toString())}updateAnalysisSummary(e,t){const n=document.getElementById("connected-count"),s=document.getElementById("disconnected-count"),o=document.getElementById("compliance-rate"),a=document.getElementById("compliance-status");if(n&&(n.textContent=e.toString()),s&&(s.textContent=t.toString()),o&&a){const i=e+t,r=i>0?Math.round(e/i*100):0;o.textContent=`${r}%`,r>=80?(a.textContent="Aprovado",a.className="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800"):(a.textContent="Revisar",a.className="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800"),a.classList.remove("hidden")}console.log(`📊 Resumo da Análise atualizado: ${e} conectados, ${t} desconectados`)}toggleLoadingState(e){const t=document.getElementById("analysis-status");t&&t.classList.toggle("hidden",!e)}toggleReportDropdown(e){const t=document.getElementById("report-dropdown");t&&t.classList.toggle("hidden",!e)}setupReportDropdown(){const e=document.getElementById("generate-report-btn"),t=document.getElementById("report-dropdown-menu");!e||!t||(e.addEventListener("click",n=>{n.stopPropagation();const s=!t.classList.contains("hidden");t.classList.toggle("hidden",s),e.setAttribute("aria-expanded",(!s).toString())}),document.addEventListener("click",()=>{t.classList.add("hidden"),e.setAttribute("aria-expanded","false")}),this.setupReportOptions())}setupReportOptions(){const e=document.getElementById("export-png");e&&e.addEventListener("click",()=>this.showWipMessage("PNG"));const t=document.getElementById("export-pdf");t&&t.addEventListener("click",()=>this.showWipMessage("PDF"));const n=document.getElementById("generate-link");n&&n.addEventListener("click",()=>this.generateShareableLink());const s=document.getElementById("export-checklist");s&&s.addEventListener("click",()=>this.showWipMessage("Checklist"))}showWipMessage(e){this.showError(`🚧 ${e} em desenvolvimento! Use "Gerar Link" por enquanto.`)}generateShareableLink(){var e,t,n,s;try{if(!this.currentAnalysisResult){this.showError("Nenhuma análise disponível para compartilhar");return}const o=((e=document.getElementById("connected-count"))==null?void 0:e.textContent)||"0",a=((t=document.getElementById("disconnected-count"))==null?void 0:t.textContent)||"0",i=((n=document.getElementById("compliance-rate"))==null?void 0:n.textContent)||"0%",r=((s=document.getElementById("compliance-status"))==null?void 0:s.textContent)||"",c=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,l=this.getExcludedComponents(),g={frameInfo:this.currentAnalysisResult.frameInfo,summary:this.currentAnalysisResult.summary,components:this.currentAnalysisResult.components,excludedComponents:l,timestamp:Date.now(),complianceRate:parseFloat(i.replace("%","")),complianceStatus:r,analysisId:c};try{localStorage.setItem(`shared-analysis-${c}`,JSON.stringify(g))}catch(u){console.warn("Não foi possível salvar dados completos no localStorage:",u)}const m=`${new URL(window.location.href).origin}/view.html?shared=true&id=${c}&connected=${o}&disconnected=${a}&compliance=${encodeURIComponent(i)}&status=${encodeURIComponent(r)}&timestamp=${Date.now()}`;navigator.clipboard.writeText(m).then(()=>{this.showSuccess("🔗 Link da análise copiado! Compartilhe com sua equipe.")}).catch(()=>{const u=document.createElement("textarea");u.value=m,document.body.appendChild(u),u.select(),document.execCommand("copy"),document.body.removeChild(u),this.showSuccess("🔗 Link da análise copiado!")}),console.log("📊 Link gerado com dados completos:",{analysisId:c,connected:o,disconnected:a,compliance:i,status:r,url:m,fullDataSaved:!0})}catch(o){console.error("Erro ao gerar link:",o),this.showError("Erro ao gerar link compartilhável")}}setCurrentAnalysisResult(e){this.currentAnalysisResult=e}getExcludedComponents(){const e=[];if(!this.currentAnalysisResult)return e;try{document.querySelectorAll(".component-toggle").forEach(n=>{if(!n.checked){const s=n.dataset.nodeId,o=this.currentAnalysisResult.components.find(a=>a.nodeId===s);o&&e.push(o)}})}catch(t){console.warn("Erro ao coletar componentes excluídos:",t)}return e}toggleFeedbackButton(e){const t=document.getElementById("show-feedback-form");t&&t.classList.toggle("hidden",!e)}toggleAnalysisSections(e){const t=document.getElementById("summary-cards"),n=document.getElementById("charts-analysis"),s=document.getElementById("components-table");t&&t.classList.toggle("hidden",!e),n&&n.classList.toggle("hidden",!e),s&&s.classList.toggle("hidden",!e)}updatePatternsCount(){const e=d.getPatterns(),t=document.getElementById("patterns-count-modal");t&&(t.textContent=`${e.length}`)}toggleDetailedFeedback(e){const t=document.getElementById("feedback-drawer"),n=document.getElementById("feedback-drawer-content");t&&n&&(e?(t.classList.remove("hidden"),t.offsetHeight,n.classList.remove("translate-x-full")):(n.classList.add("translate-x-full"),setTimeout(()=>{t.classList.add("hidden")},300)))}setupFeedbackForm(){const e=document.getElementById("feedback-type"),t=document.getElementById("component-name-field"),n=document.getElementById("expected-classification-field");e&&e.addEventListener("change",()=>{const s=e.value;t&&t.classList.toggle("hidden",s!=="missed_component"&&s!=="wrong_classification"&&s!=="should_ignore"),n&&n.classList.toggle("hidden",s!=="missed_component"&&s!=="wrong_classification")})}showSuggestedComponents(e){const t=document.getElementById("suggested-components"),n=document.getElementById("suggestions-list");if(!(!t||!n)){if(e.length===0){t.classList.add("hidden");return}t.classList.remove("hidden"),n.innerHTML="",e.forEach(s=>{const o=document.createElement("div");o.className="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100",o.innerHTML=`
        <div class="flex-1">
          <span class="text-sm font-medium text-gray-900">${s.name}</span>
          <span class="ml-2 text-xs text-gray-500">(${s.type})</span>
        </div>
        <button class="text-xs text-red-600 hover:text-red-800 font-medium">
          Usar este
        </button>
      `,o.addEventListener("click",()=>{const a=document.getElementById("component-name"),i=document.getElementById("feedback-type");a&&(a.value=s.name),i&&(i.value="missed_component",i.dispatchEvent(new Event("change")))}),n.appendChild(o)})}}updateLearningStats(){const e=d.getLearningStats(),t=document.getElementById("learning-stats");t&&(t.textContent=`${e.totalPatterns} padrões • ${e.totalFeedbacks} feedbacks • ${e.totalRules} regras ativas`)}clearFeedbackForm(){const e=document.getElementById("detailed-feedback");if(!e)return;const t=e.querySelector("#feedback-type"),n=e.querySelector("#component-name"),s=e.querySelector("#expected-classification"),o=e.querySelector("#feedback-description");t&&(t.value=""),n&&(n.value=""),s&&(s.value=""),o&&(o.value="");const a=document.getElementById("component-name-field"),i=document.getElementById("expected-classification-field");a&&a.classList.add("hidden"),i&&i.classList.add("hidden")}collectFeedbackData(){const e=document.getElementById("feedback-type"),t=document.getElementById("component-name"),n=document.getElementById("expected-classification"),s=document.getElementById("feedback-description");if(!e||!s)return null;const o=e.value,a=s.value.trim();if(!o||!a)return this.showError("Por favor, preencha o tipo e a descrição do problema"),null;const i={type:o,description:a,timestamp:Date.now()};return t&&t.value.trim()&&(i.componentName=t.value.trim()),n&&n.value&&(i.expectedClassification=n.value),i}showError(e){const t=document.createElement("div");t.className="bg-red-50 border border-red-200 rounded-md p-4 mb-4",t.innerHTML=`
      <div class="flex">
        <svg class="h-5 w-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
        </svg>
        <div>
          <h3 class="text-sm font-medium text-red-800">Erro na análise</h3>
          <p class="text-sm text-red-700 mt-1">${e}</p>
        </div>
      </div>
    `;const n=document.querySelector("main");n&&n.firstChild&&n.insertBefore(t,n.firstChild),setTimeout(()=>{t.remove()},5e3)}showSuccess(e){const t=document.createElement("div");t.className="bg-green-50 border border-green-200 rounded-md p-4 mb-4",t.innerHTML=`
      <div class="flex">
        <svg class="h-5 w-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
        </svg>
        <div>
          <h3 class="text-sm font-medium text-green-800">Sucesso</h3>
          <p class="text-sm text-green-700 mt-1">${e}</p>
        </div>
      </div>
    `;const n=document.querySelector("main");n&&n.firstChild&&n.insertBefore(t,n.firstChild),setTimeout(()=>{t.remove()},3e3)}}class b{constructor(){this.currentResult=null,this.currentFrameNode=null,this.chartManager=new x,this.uiManager=new S,this.uiManager.setChartManager(this.chartManager),this.checkAuthAndInit()}checkAuthAndInit(){p.isAuthenticated()?(this.showMainApp(),this.init()):this.showLoginScreen()}showLoginScreen(){const e=document.getElementById("login-screen"),t=document.getElementById("main-app");e&&e.classList.remove("hidden"),t&&t.classList.add("hidden"),this.setupLoginListeners()}showMainApp(){const e=document.getElementById("login-screen"),t=document.getElementById("main-app");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden")}setupLoginListeners(){const e=document.getElementById("login-form");e&&e.addEventListener("submit",t=>this.handleLogin(t))}handleLogin(e){e.preventDefault();const t=document.getElementById("login-email"),n=document.getElementById("login-password");if(!t||!n)return;const s=t.value.trim(),o=n.value.trim();p.login(s,o)?(this.showMainApp(),this.init()):this.showLoginError("Email ou senha incorretos")}showLoginError(e){const t=document.querySelector(".login-error");t&&t.remove();const n=document.createElement("div");n.className="login-error bg-red-50 border border-red-200 rounded-md p-3 mt-4",n.innerHTML=`
      <div class="flex">
        <svg class="h-5 w-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
        </svg>
        <p class="text-sm text-red-700">${e}</p>
      </div>
    `;const s=document.getElementById("login-form");s&&s.appendChild(n)}init(){d.initializeKnownPatterns(),this.loadSavedToken(),this.uiManager.updatePatternsCount(),this.uiManager.setupFeedbackForm(),this.uiManager.updateLearningStats(),this.setupEventListeners()}setupEventListeners(){const e=document.querySelector('[onclick="analyzeFrame()"]');e&&(e.removeAttribute("onclick"),e.addEventListener("click",()=>this.analyzeFrame()));const t=document.getElementById("toggle-token-visibility");t&&t.addEventListener("click",()=>this.toggleTokenVisibility()),this.uiManager.setupReportDropdown();const n=document.getElementById("show-feedback-form");n&&n.addEventListener("click",()=>this.showFeedbackForm());const s=document.getElementById("cancel-feedback");s&&s.addEventListener("click",()=>this.cancelFeedback());const o=document.getElementById("submit-feedback");o&&o.addEventListener("click",()=>this.submitFeedback());const a=document.getElementById("figma-token");a&&a.addEventListener("input",()=>{const y=a.value.trim();y&&d.saveToken(y)});const i=document.getElementById("show-instructions"),r=document.getElementById("instructions-modal"),c=document.getElementById("close-instructions"),l=document.getElementById("close-instructions-btn");i&&r&&i.addEventListener("click",()=>{r.classList.remove("hidden")}),c&&r&&c.addEventListener("click",()=>{r.classList.add("hidden")}),l&&r&&l.addEventListener("click",()=>{r.classList.add("hidden")}),r&&r.addEventListener("click",y=>{y.target===r&&r.classList.add("hidden")});const g=document.getElementById("close-feedback-drawer"),I=document.getElementById("feedback-overlay");g&&g.addEventListener("click",()=>this.cancelFeedback()),I&&I.addEventListener("click",()=>this.cancelFeedback());const m=document.getElementById("export-learning-data");m&&m.addEventListener("click",()=>this.exportLearningData());const u=document.getElementById("logout-btn");u&&u.addEventListener("click",()=>this.handleLogout())}handleLogout(){p.logout(),this.currentResult=null,this.currentFrameNode=null,this.uiManager.toggleAnalysisSections(!1),this.uiManager.toggleReportDropdown(!1),this.uiManager.toggleFeedbackButton(!1),this.showLoginScreen()}loadSavedToken(){const e=d.getToken();if(e){const t=document.getElementById("figma-token");t&&(t.value=e)}}toggleTokenVisibility(){const e=document.getElementById("figma-token"),t=document.getElementById("eye-icon");if(e&&t){const n=e.type==="password";e.type=n?"text":"password",t.innerHTML=n?'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>':'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>'}}async analyzeFrame(){const e=document.getElementById("figma-token"),t=document.getElementById("figma-url");if(!e||!t){this.uiManager.showError("Elementos de entrada não encontrados");return}const n=e.value.trim(),s=t.value.trim();if(!n){this.uiManager.showError("Token do Figma é obrigatório");return}if(!s){this.uiManager.showError("URL do frame é obrigatória");return}this.uiManager.toggleLoadingState(!0);try{const o=w.parseUrl(s);if(!o)throw new Error("URL do Figma inválida");const a=new w(n);if(!await a.validateToken())throw new Error("Token do Figma inválido ou sem permissões");const r=await a.fetchFrame(o.fileKey,o.nodeId);if(!r)throw new Error("Frame não encontrado");const c=v.analyzeFrame(r,s),l=d.getPatternByFrameId(o.nodeId);l&&(console.log("Padrão conhecido encontrado:",l),l.corrections&&(c.summary.connected=l.corrections.connected,c.summary.disconnected=l.corrections.disconnected,c.summary.total=l.corrections.connected+l.corrections.disconnected)),this.currentResult=c,this.currentFrameNode=r,this.uiManager.setCurrentAnalysisResult(c),this.updateUI(c),this.uiManager.toggleAnalysisSections(!0),this.uiManager.toggleReportDropdown(!0),this.uiManager.toggleFeedbackButton(!0),this.uiManager.showSuccess("Análise concluída com sucesso!")}catch(o){console.error("Erro na análise:",o),this.uiManager.showError(o instanceof Error?o.message:"Erro desconhecido na análise")}finally{this.uiManager.toggleLoadingState(!1)}}updateUI(e){this.uiManager.updateSummaryCards(e),this.uiManager.updateComponentsTable(e),this.chartManager.updatePieChart(e)}exportLearningData(){try{d.exportAllLearningData(),this.uiManager.showSuccess("Dados exportados! Envie o arquivo para consolidação.")}catch(e){console.error("Erro ao exportar dados:",e),this.uiManager.showError("Erro ao exportar dados de aprendizado")}}showFeedbackForm(){if(!this.currentResult||!this.currentFrameNode){this.uiManager.showError("Nenhuma análise ativa para dar feedback");return}this.uiManager.toggleDetailedFeedback(!0);const e=v.getSuggestedMissedComponents(this.currentFrameNode);this.uiManager.showSuggestedComponents(e),this.uiManager.updateLearningStats()}cancelFeedback(){this.uiManager.toggleDetailedFeedback(!1),this.uiManager.clearFeedbackForm()}submitFeedback(){if(!this.currentResult){this.uiManager.showError("Nenhuma análise ativa para dar feedback");return}const e=this.uiManager.collectFeedbackData();if(e)try{const t=w.parseUrl(this.currentResult.frameInfo.url);if(t)d.addFeedbackToPattern(t.nodeId,e),this.uiManager.showSuccess("Feedback salvo! O sistema aprendeu e um arquivo foi baixado automaticamente. Envie este arquivo para melhorar o sistema para todos!"),this.uiManager.updateLearningStats(),this.uiManager.updatePatternsCount(),this.cancelFeedback(),console.log("📚 Feedback salvo:",e),console.log("🧠 Sistema aprendeu e criou novas regras automáticas");else throw new Error("Não foi possível identificar o frame para salvar o feedback")}catch(t){console.error("Erro ao salvar feedback:",t),this.uiManager.showError(t instanceof Error?t.message:"Erro ao salvar feedback")}}}document.addEventListener("DOMContentLoaded",()=>{new b});window.FigmaAnalyzerApp=b;
